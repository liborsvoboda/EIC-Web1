/**
 * Copyright (c) Meta Platforms, Inc. and affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 */

import{useLexicalComposerContext as e}from"@lexical/react/LexicalComposerContext";import{TableNode as t,TableCellNode as r,TableRowNode as o,INSERT_TABLE_COMMAND as n,$createTableNodeWithDimensions as l,$computeTableMapSkipCellCheck as s,$createTableCellNode as i,$isTableNode as a,$getNodeTriplet as c,$computeTableMap as f,$isTableRowNode as d,$isTableCellNode as u,applyTableHandlers as g}from"@lexical/table";import{mergeRegister as m,$insertNodeToNearestRoot as p,$insertFirst as h}from"@lexical/utils";import{$isTextNode as C,COMMAND_PRIORITY_EDITOR as x,$createParagraphNode as w,$getNodeByKey as S}from"lexical";import{useEffect as v}from"react";function N(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var b=N((function(e){const t=new URLSearchParams;t.append("code",e);for(let e=1;e<arguments.length;e++)t.append("v",arguments[e]);throw Error(`Minified Lexical error #${e}; visit https://lexical.dev/docs/error?${t} for the full message or use the non-minified dev environment for full errors and additional helpful warnings.`)}));function y({hasCellMerge:N=!0,hasCellBackgroundColor:y=!0,hasTabHandler:L=!0}){const[M]=e();return v((()=>(M.hasNodes([t,r,o])||b(10),m(M.registerCommand(n,(({columns:e,rows:t,includeHeaders:r})=>{const o=l(Number(t),Number(e),r);p(o);const n=o.getFirstDescendant();return C(n)&&n.select(),!0}),x),M.registerNodeTransform(t,(e=>{const[t]=s(e,null,null),r=t.reduce(((e,t)=>Math.max(e,t.length)),0);for(let e=0;e<t.length;++e){const o=t[e].length;if(o===r)continue;const n=t[e][o-1].cell;for(let e=o;e<r;++e){const e=i(0);e.append(w()),null!==n?n.insertAfter(e):h(n,e)}}}))))),[M]),v((()=>{const e=new Map,r=t=>{const r=t.getKey(),o=M.getElementByKey(r);if(o&&!e.has(r)){const n=g(t,o,M,L);e.set(r,n)}},o=M.registerMutationListener(t,(t=>{for(const[o,n]of t)if("created"===n)M.getEditorState().read((()=>{const e=S(o);a(e)&&r(e)}));else if("destroyed"===n){const t=e.get(o);void 0!==t&&(t.removeListeners(),e.delete(o))}}),{skipInitialization:!1});return()=>{o();for(const[,t]of e)t.removeListeners()}}),[M,L]),v((()=>{if(!N)return M.registerNodeTransform(r,(e=>{if(e.getColSpan()>1||e.getRowSpan()>1){const[,,t]=c(e),[r]=f(t,e,e),o=r.length,n=r[0].length;let l=t.getFirstChild();d(l)||b(175);const s=[];for(let e=0;e<o;e++){0!==e&&(l=l.getNextSibling(),d(l)||b(175));let t=null;for(let o=0;o<n;o++){const n=r[e][o],a=n.cell;if(n.startRow===e&&n.startColumn===o)t=a,s.push(a);else if(a.getColSpan()>1||a.getRowSpan()>1){u(a)||b(176);const e=i(a.__headerState);null!==t?t.insertAfter(e):h(l,e)}}}for(const e of s)e.setColSpan(1),e.setRowSpan(1)}}))}),[M,N]),v((()=>{if(!y)return M.registerNodeTransform(r,(e=>{null!==e.getBackgroundColor()&&e.setBackgroundColor(null)}))}),[M,y,N]),null}export{y as TablePlugin};
